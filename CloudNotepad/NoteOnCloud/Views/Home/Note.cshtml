@{
    ViewBag.Title = "Note";
}

<h2>Note</h2>

<div class="container">
    <textarea id="txtNote" rows="20" cols="500" placeholder="Enter your note"></textarea>
    <input type="hidden" id="url" />
</div>
@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            // Reference the auto-generated proxy for the hub.
            var noteHub = $.connection.noteHub;
            var noteChanged = false;
            var sentText = '';
            var textToBeSent = '';

            // Create a function that the hub can call back to display messages.
            noteHub.client.updateNoteOnPage = function (name, message) {
                // Add the message to the page.
                $('#txtNote').append(htmlEncode(message));
                sentText = sentText.concat(message);
            };

            // Get the user name and store it to prepend to messages.
            $('#url').val(prompt('Enter the URL:', ''));

            // Set initial focus to message input box.
            $('#txtNote').focus();

            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#txtNote').on('input propertychange change', function () {
                    console.log('Textarea Change');
                    noteChanged = true;
                    var currentText = $('#txtNote').val();
                    textToBeSent = currentText.replace(sentText, '');
                });
                setInterval(updateServerNote, 50);
            });

            function updateServerNote() {
                // Only update server if we have a new movement
                if (noteChanged) {
                    noteHub.server.updateNote($('#url').val(), textToBeSent);
                    noteChanged = false;
                    sentText = sentText.concat(textToBeSent);
                }
            }
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
    </script>
}

